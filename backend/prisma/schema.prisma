// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum FoodSource {
  ciqual
  custom
}

enum Sex {
  male
  female
}

enum ActivityLevel {
  sedentary   // 1.2
  light      // 1.375
  moderate   // 1.55
  very       // 1.725
  athlete    // 1.9
}

enum Goal {
  maintain
  lose
  gain
}

enum GoalRate {
  slow
  medium
  fast
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile  Profile?
  meals    Meal[]
  workouts Workout[]

  @@map("users")
}

model Profile {
  id             String         @id @default(uuid())
  userId         String         @unique
  sex            Sex?
  birthdate      DateTime?      @db.Date
  heightCm       Float?
  weightKg       Float?
  activityLevel  ActivityLevel?
  goal           Goal?
  goalRate       GoalRate?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model Meal {
  id        String   @id @default(uuid())
  userId    String
  eatenAt   DateTime
  mealType  String // breakfast, lunch, dinner, snack
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items MealItem[]

  @@index([userId, eatenAt])
  @@map("meals")
}

model MealItem {
  id        String   @id @default(uuid())
  mealId    String

  /// Référence externe (optionnelle) + infos snapshotées
  foodSource     FoodSource
  externalFoodId String?
  foodName       String
  foodBrand      String?

  /// Macros de référence (souvent pour 100g) snapshotées au moment de l'ajout
  kcal100g    Float
  protein100g Float
  carbs100g   Float
  fat100g     Float
  sugar100g   Float?
  fiber100g   Float?

  grams     Float
  // Snapshot des macros calculés au moment de l'ajout
  kcal      Float
  protein   Float
  carbs     Float
  fat       Float
  sugar     Float @default(0)
  fiber     Float @default(0)
  createdAt DateTime @default(now())

  meal Meal @relation(fields: [mealId], references: [id], onDelete: Cascade)

  @@index([externalFoodId])
  @@map("meal_items")
}

model Workout {
  id          String   @id @default(uuid())
  userId      String
  startedAt   DateTime
  type        String // run, strength
  durationMin Int
  rpe         Int? // Rate of Perceived Exertion 1-10
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  runDetails RunDetails?

  @@index([userId, startedAt])
  @@map("workouts")
}

model RunDetails {
  id           String   @id @default(uuid())
  workoutId    String   @unique
  distanceKm   Float
  avgPaceSecKm Float
  createdAt    DateTime @default(now())

  workout Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  @@map("run_details")
}
